# BirthKeeper 对话交接文档

## 1. 当前工作目录
- 项目路径：`D:\MobileApps\BirthKeeper`
- 环境注入脚本：`D:\Video Downloader\环境一键配置.ps1`

## 2. 当前总体进度（按 6 周计划）
- 第 1-5 周核心功能：已完成
  - 多模块工程、Room 三表、联系人 CRUD、身份证解析与脱敏
  - OCR（拍照/相册/识别/候选回填）
  - 提醒配置中心 + WorkManager 每日扫描 + AlarmManager 精确补偿 + 通知点击回写
  - 身份证号加密存储（Keystore + AES-GCM）
  - 备份导出/导入（覆盖/合并）+ 文件级加密 + 事务回滚
- 第 6 周测试补齐：进行中
  - 已有：`core-domain` 用例、`feature-person`/`feature-capture`/`feature-reminder` ViewModel/解析测试
  - 本轮补齐：`core-data` 备份集成测试、`core-common` 隐私工具测试、`app` 调度时间计算 + WorkManager 调度集成测试

## 3. 本轮新增改动（本次继续开发）

### 3.1 `core-data`：备份导入导出集成测试
- 新增：`core-data/src/test/java/com/zhongxul/birthkeeper/core/data/repository/BackupRepositoryImplTest.kt`
- 覆盖场景：
  - 导出后覆盖导入可恢复联系人与提醒配置
  - `MERGE` 模式下按 `updatedAt` 冲突策略：旧数据跳过、新数据更新
  - `OVERWRITE` 导入遇非法 payload 时事务回滚（已验证不落半包）

### 3.2 `core-data`：测试依赖补齐
- 修改：`core-data/build.gradle.kts`
- 新增：`testOptions.unitTests.isIncludeAndroidResources = true`
- 新增测试依赖：`junit4`、`kotlinx-coroutines-test`、`androidx-room-testing`、`androidx-test-core`、`robolectric`

### 3.3 `core-common`：隐私工具单测补齐
- 修改：`core-common/build.gradle.kts`（新增单测配置与依赖）
- 新增：
  - `core-common/src/test/java/com/zhongxul/birthkeeper/core/common/util/MaskingUtilsTest.kt`
  - `core-common/src/test/java/com/zhongxul/birthkeeper/core/common/util/BackupCipherTest.kt`
  - `core-common/src/test/java/com/zhongxul/birthkeeper/core/common/util/IdNumberCryptoTest.kt`
- 覆盖：脱敏规则、备份加解密回环、身份证加解密回环与异常兜底

### 3.4 `app`：提醒调度可测性增强
- 修改：`app/src/main/java/com/zhongxul/birthkeeper/reminder/ReminderScheduler.kt`
  - 将首次调度延迟计算提取为 `internal fun computeInitialDelay(now: LocalDateTime)`
  - 新增 `internal fun dailyScanUniqueWorkName()` 便于校验唯一周期任务
- 新增：`app/src/test/java/com/zhongxul/birthkeeper/reminder/ReminderSchedulerTest.kt`
  - 覆盖早于 8:00、等于 8:00、晚于 8:00 三种延迟计算场景
- 新增：`app/src/test/java/com/zhongxul/birthkeeper/reminder/ReminderSchedulerIntegrationTest.kt`
  - 覆盖 `ReminderScheduler.initialize()` 后的通知渠道创建与唯一周期任务入队校验

### 3.5 `app`：新增真机 UI 自动化测试（androidTest）
- 新增：`app/src/androidTest/java/com/zhongxul/birthkeeper/MainActivityAndroidTest.kt`
  - 覆盖新增联系人流程（打开新增弹层 -> 输入必填项 -> 保存成功后弹层关闭）
  - 覆盖通知跳转流程（带 `EXTRA_OPEN_PERSON_ID` 的 Intent 触发编辑目标联系人）
  - 覆盖 OCR 兜底手动回填流程（进入扫描页手动填写姓名/证件号 -> 回填联系人编辑页）
- 修改：`app/src/main/java/com/zhongxul/birthkeeper/BirthKeeperApp.kt`
  - 底部导航新增 `testTag`（联系人/扫描/提醒）以稳定定位导航入口
- 修改：`feature-person/src/main/java/com/zhongxul/birthkeeper/feature/person/PersonListScreen.kt`
  - 新增若干 `testTag`（新增按钮、姓名/关系/证件号输入框、保存按钮）以稳定定位 UI
- 修改：`feature-capture/src/main/java/com/zhongxul/birthkeeper/feature/capture/CaptureScreen.kt`
  - 新增 `testTag`（相册按钮、姓名/证件号输入框、回填按钮）以支持兜底回填链路测试
- 修改：`app/build.gradle.kts` 与 `gradle/libs.versions.toml`
  - 增加 Compose UI Test 与 `androidx.test.rules` 依赖
### 3.6 版本目录依赖扩展
- 修改：`gradle/libs.versions.toml`
- 新增版本/库：`androidx-test-core`、`robolectric`、`androidx-room-testing`

### 3.7 第6周性能回归落地
- 新增：`scripts/startup-benchmark.ps1`
  - 支持批量冷启动采样（`force-stop + am start -W`）
  - 输出 `TotalTime/WaitTime` 统计（均值、P95、最小、最大）
  - 支持导出原始 CSV
- 新增：`docs/第6周-性能回归记录.md`
  - 已记录 2026-02-13 真机（`V2171A`）20 次冷启动结果
  - 结论：平均值接近达标，但 `P95` 仍高于 1.5s，需继续优化

### 3.8 全量文档进度同步（2026-02-13）
- 更新：`README.md`
  - 从“占位开发中”同步为“核心能力已落地 + 当前性能差距”
  - 增补常用构建、测试、性能采样命令
- 更新：`docs/开发任务清单-6周版.md`
  - 新增“执行状态同步”小节（第1-5周完成，第6周剩余项明确）
- 更新：`docs/生日记录提醒App-初步设计方案.md`
  - 新增“进度同步”小节，标记设计项到实现项的落地情况
- 更新：`docs/生日记录提醒App-技术与实现设计.md`
  - 新增“实施状态同步”小节，补充测试与性能现状
- 更新：`docs/第6周-性能回归记录.md`
  - 新增“当前状态标记”小节，明确是否达标与下次复测口径

### 3.9 release 口径性能回归与构建调整（2026-02-13）
- 修改：`app/build.gradle.kts`
  - `release` 构建签名调整为本地 `debug` 签名，用于真机安装与性能回归
  - 说明：该配置仅用于本地回归，不代表商店发布签名策略
- 新增性能样本：`docs/startup-benchmark-2026-02-13-release.csv`
  - 20 次冷启动（COLD）结果：
    - `TotalTime` 平均 `453.6ms`、`P95 535ms`
    - `WaitTime` 平均 `465.2ms`、`P95 549ms`
  - 结论：`release` 发布口径已稳定满足 `<1.5s` 目标

### 3.10 提醒状态流转自动化 + 隐私发布检查落地（2026-02-13）
- 修改：`app/src/androidTest/java/com/zhongxul/birthkeeper/MainActivityAndroidTest.kt`
  - 新增提醒状态流转用例：`PLANNED -> SENT -> CLICKED -> DONE`
  - 通过显式广播触发 `BirthdayReminderAlarmReceiver` 验证 `SENT`
  - 通过通知 Intent（`EXTRA_REMINDER_LOG_ID`）验证 `CLICKED`
  - 在提醒中心点击“标记已处理”验证 `DONE`
- 修改：`feature-reminder/src/main/java/com/zhongxul/birthkeeper/feature/reminder/ReminderScreen.kt`
  - 新增提醒操作按钮 `testTag`（按 `logId` 生成）提升 UI 测试稳定性
- 修改：`app/src/main/AndroidManifest.xml`
  - `android:allowBackup` 调整为 `false`，关闭系统自动备份
  - 显式设置 `android:usesCleartextTraffic="false"`
- 新增：`docs/发布前隐私与发布检查清单.md`
  - 汇总隐私自检项、发布检查项、当前已完成与待收口项

## 4. 已验证命令（本轮）
先注入环境：
```powershell
. "D:\Video Downloader\环境一键配置.ps1"
```

已通过：
```powershell
.\gradlew.bat :core-data:testDebugUnitTest
.\gradlew.bat :core-common:testDebugUnitTest
.\gradlew.bat :app:testDebugUnitTest
.\gradlew.bat :feature-person:test
.\gradlew.bat :feature-capture:test
.\gradlew.bat :feature-reminder:test
.\gradlew.bat :core-domain:test
.\gradlew.bat :app:assembleDebug
.\gradlew.bat :app:connectedDebugAndroidTest
.\gradlew.bat connectedAndroidTest
.\scripts\startup-benchmark.ps1 -Runs 20 -OutputCsv .\docs\startup-benchmark-2026-02-13.csv
.\gradlew.bat :app:installRelease
.\scripts\startup-benchmark.ps1 -Runs 20 -OutputCsv .\docs\startup-benchmark-2026-02-13-release.csv
.\gradlew.bat :app:connectedDebugAndroidTest "-Pandroid.testInstrumentationRunnerArguments.class=com.zhongxul.birthkeeper.MainActivityAndroidTest"
```

## 5. 当前未完成项（第 6 周剩余）
- 当前真机已可执行 `connectedAndroidTest`，但各模块 `androidTest` 源集多数仍是 `NO-SOURCE`
- 提醒调度与通知链路的端到端测试仍可继续加深（如跨天/边界日期）
- 需补充多机型 `release` 口径性能回归（当前仅 `V2171A`）
- 发布前需切换正式签名配置（当前 `release` 使用本地 `debug` 签名用于回归）

## 6. 下一步建议（可直接接着做）
1. 增加至少 1 台中端机的 `release` 冷启动回归并更新文档。
2. 切换正式发布签名并执行 RC 打包验证。
3. 按 `docs/发布前隐私与发布检查清单.md` 收口剩余待办项。

## 7. 注意事项
- `git status` 目前仍是初始大量 `??` 状态（仓库未做分批提交）。
- Windows 控制台若出现中文乱码，请读取文件时显式 `-Encoding UTF8`。
